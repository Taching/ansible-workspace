---
- name: Check if iTerm2 preferences file exists in repo
  stat:
    path: "{{ playbook_dir }}/files/iterm2/com.googlecode.iterm2.plist"
  register: iterm2_plist
  tags: ['iterm2']

- name: Check if iTerm2 preferences file exists locally
  stat:
    path: "{{ ansible_facts['env']['HOME'] }}/Library/Preferences/com.googlecode.iterm2.plist"
  register: iterm2_local_plist
  tags: ['iterm2']

- name: Ensure iTerm2 preferences directory exists in repo
  file:
    path: "{{ playbook_dir }}/files/iterm2"
    state: directory
    mode: "0755"
  tags: ['iterm2']

- name: Download iTerm2 preferences from URL (if configured and missing in repo)
  get_url:
    url: "{{ iterm2_plist_url }}"
    dest: /tmp/iterm2.plist
    mode: "0644"
    validate_certs: "{{ (lookup('env','GALAXY_IGNORE_CERTS') != '1') }}"
  when: not iterm2_plist.stat.exists and (iterm2_plist_url is defined) and (iterm2_plist_url | length > 0)
  tags: ['iterm2']

- name: Check if downloaded iTerm2 preferences exist
  stat:
    path: /tmp/iterm2.plist
  register: iterm2_downloaded_plist
  tags: ['iterm2']

- name: Select iTerm2 preferences source
  set_fact:
    iterm2_source_plist: >-
      {{ (iterm2_plist.stat.exists | bool) | ternary(playbook_dir + '/files/iterm2/com.googlecode.iterm2.plist',
         (iterm2_local_plist.stat.exists | bool) | ternary(ansible_facts['env']['HOME'] + '/Library/Preferences/com.googlecode.iterm2.plist',
         '/tmp/iterm2.plist')) }}
  when: iterm2_plist.stat.exists or iterm2_local_plist.stat.exists or iterm2_downloaded_plist.stat.exists
  tags: ['iterm2']

- name: Copy local iTerm2 preferences into repo (if missing)
  copy:
    src: "{{ ansible_facts['env']['HOME'] }}/Library/Preferences/com.googlecode.iterm2.plist"
    dest: "{{ playbook_dir }}/files/iterm2/com.googlecode.iterm2.plist"
    remote_src: true
    mode: "0644"
  when: not iterm2_plist.stat.exists and iterm2_local_plist.stat.exists
  tags: ['iterm2']

- name: Convert iTerm2 plist to XML
  command: >
    plutil -convert xml1 -o /tmp/iterm2.plist {{ iterm2_source_plist }}
  when: iterm2_source_plist is defined
  changed_when: false
  tags: ['iterm2']

- name: Quit iTerm2 before importing preferences
  command: osascript -e 'tell application "iTerm2" to quit'
  when: iterm2_source_plist is defined
  ignore_errors: true
  changed_when: false
  tags: ['iterm2']

- name: Import iTerm2 preferences
  command: defaults import com.googlecode.iterm2 /tmp/iterm2.plist
  when: iterm2_source_plist is defined
  changed_when: false
  tags: ['iterm2']

- name: Point iTerm2 to repo preferences folder
  command: >
    defaults write com.googlecode.iterm2 PrefsCustomFolder
    -string "{{ playbook_dir }}/files/iterm2"
  when: iterm2_source_plist is defined
  changed_when: true
  tags: ['iterm2']

- name: Enable loading preferences from custom folder
  command: defaults write com.googlecode.iterm2 LoadPrefsFromCustomFolder -bool true
  when: iterm2_source_plist is defined
  changed_when: true
  tags: ['iterm2']

- name: Relaunch iTerm2 to apply preferences
  command: open -a iTerm
  when: iterm2_source_plist is defined
  changed_when: false
  tags: ['iterm2']
